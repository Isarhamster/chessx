#!/bin/sh
[ $# -eq 0 ] && { echo "Usage: $0 QT_INSTALL_PREFIX // Creator: %{Qt:QT_INSTALL_PREFIX} in %{buildDir}/release"; exit 1; }

DIR=${0%/*}
RELEASEDIR=`pwd`
BUILDDIR=$RELEASEDIR/..

VERSION=$(awk '
    BEGIN { major="0"; minor="0"; patch="0" }
    /#define VERSION_MAJOR/ {gsub(/[^0-9]/, "", $3); major=$3; }
    /#define VERSION_MINOR/ {gsub(/[^0-9]/, "", $3); minor=$3; }
    /#define REVISION/ {gsub(/[^0-9]/, "", $3); patch=$3; }
    END {
        print major "." minor "." patch
    }' ${DIR}/../src/database/version.h)
    
echo "Updating ${DIR}/info.plist to version ${VERSION}"
/usr/libexec/PlistBuddy -c "delete :CFBundleVersion" ${DIR}/info.plist
/usr/libexec/PlistBuddy -c "delete :CFBundleShortVersionString" ${DIR}/info.plist
/usr/libexec/PlistBuddy -c "add :CFBundleVersion string ${VERSION}" ${DIR}/info.plist
/usr/libexec/PlistBuddy -c "add :CFBundleShortVersionString string ${VERSION}" ${DIR}/info.plist

echo "Build image for chessx-${VERSION} in ${RELEASEDIR}"
QTBASE=$1
QTBIN=$1/bin
rm -rf chessx.app.original
rm -rf chessx.modified.app
cp -r chessx.app chessx.app-original
${DIR}/fix_paths.sh "${QTBASE}" chessx
${QTBIN}/macdeployqt chessx.app
rm -f chessx.zip
ditto -ck --rsrc --sequesterRsrc chessx.app chessx.zip

# Fix owner and rights before
chown -R $(whoami):staff chessx.app
chmod -R u+rwX,go+rX chessx.app
xattr -cr chessx.app

rm -f ${DIR}/../Packages/chessx-${VERSION}.dmg

${DIR}/make_dmg.sh

mv chessx.app chessx.modified.app
mv chessx.app-original chessx.app
mv -v ${RELEASEDIR}/ChessX.dmg ${DIR}/../Packages/chessx-${VERSION}.dmg
